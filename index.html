<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wine Tasting & Quiz</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; width: 100%; }
    .font-display { font-family: 'Playfair Display', Georgia, serif; }
    .font-body { font-family: 'Lato', system-ui, sans-serif; }
    .wine-gradient { background: linear-gradient(135deg, #8b1e3f 0%, #4a0f25 100%); }
    .card-light { background: #f4efe7; }
    .accent-deep { color: #8b1e3f; }
    .accent-light { color: #f4efe7; }
    .btn-primary { background: #8b1e3f; color: #f4efe7; min-height: 48px; transition: all .2s; }
    .btn-primary:active { background: #6a1630; }
    .nav-btn { min-height: 44px; font-size: 14px; transition: all .2s; -webkit-tap-highlight-color: transparent; }
    .option-btn { border: 2px solid #ddd; transition: all .2s; min-height: 44px; font-size: 16px; font-weight: 500; padding: 12px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; background: white; color: #333; }
    .option-btn.selected { background: #8b1e3f; color: #f4efe7; border-color: #8b1e3f; }
    input, textarea, select { font-size: 16px; -webkit-appearance: none; appearance: none; border-radius: 8px; }
    input[type="text"], input[type="number"], textarea, select { padding: 12px 14px; min-height: 44px; }
    .star-rating { display: flex; gap: 4px; font-size: 24px; }
    .star-btn { background: none; border: none; cursor: pointer; padding: 0; font-size: 24px; transition: all .2s; -webkit-tap-highlight-color: transparent; }
    .podium { display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 16px; align-items: flex-end; margin-bottom: 24px; }
    .podium-position { background: white; border-radius: 8px; padding: 16px; text-align: center; }
    @media (max-width: 640px) {
      .podium { grid-template-columns: 1fr; }
      .nav-btn { font-size: 12px; padding: 0.5rem 0.5rem; }
    }
  </style>
</head>
<body class="h-full font-body overflow-hidden">
  <div id="app" class="h-full w-full wine-gradient flex flex-col">
    <div class="flex-1 overflow-auto p-4 pb-20">
      <div id="debug-banner" class="hidden max-w-4xl mx-auto mb-4 bg-yellow-100 text-yellow-900 border border-yellow-300 rounded-lg p-3 text-sm"></div>
      <header class="text-center mb-6">
        <h1 id="event-title" class="font-display text-3xl sm:text-4xl font-bold accent-light mb-2">üç∑ Wine Tasting</h1>
        <p id="event-subtitle" class="text-white/80 text-sm"></p>
      </header>

      <div class="flex justify-center gap-2 mb-6 flex-wrap max-w-6xl mx-auto">
        <button id="btn-settings" class="px-2 sm:px-3 py-2 rounded-full btn-primary nav-btn font-semibold" onclick="showSettings()">‚öôÔ∏è Settings</button>
        <button id="btn-tasting" class="px-2 sm:px-3 py-2 rounded-full bg-white/20 accent-light nav-btn font-semibold" onclick="showTasting()">üç∑ Tasting</button>
        <button id="btn-quiz" class="px-2 sm:px-3 py-2 rounded-full bg-white/20 accent-light nav-btn font-semibold" onclick="showQuiz()">üß† Quiz</button>
        <button id="btn-tasting-results" class="px-2 sm:px-3 py-2 rounded-full bg-white/20 accent-light nav-btn font-semibold" onclick="showTastingResults()">üçá Wine Results</button>
        <button id="btn-quiz-results" class="px-2 sm:px-3 py-2 rounded-full bg-white/20 accent-light nav-btn font-semibold" onclick="showQuizResults()">üèÜ Quiz Results</button>
      </div>

      <div class="max-w-4xl mx-auto">

        <datalist id="country-list">
  <option value="Afghanistan"></option>
  <option value="Albania"></option>
  <option value="Algeria"></option>
  <option value="Andorra"></option>
  <option value="Angola"></option>
  <option value="Antigua and Barbuda"></option>
  <option value="Argentina"></option>
  <option value="Armenia"></option>
  <option value="Australia"></option>
  <option value="Austria"></option>
  <option value="Azerbaijan"></option>
  <option value="Bahamas"></option>
  <option value="Bahrain"></option>
  <option value="Bangladesh"></option>
  <option value="Barbados"></option>
  <option value="Belarus"></option>
  <option value="Belgium"></option>
  <option value="Belize"></option>
  <option value="Benin"></option>
  <option value="Bhutan"></option>
  <option value="Bolivia"></option>
  <option value="Bosnia and Herzegovina"></option>
  <option value="Botswana"></option>
  <option value="Brazil"></option>
  <option value="Brunei"></option>
  <option value="Bulgaria"></option>
  <option value="Burkina Faso"></option>
  <option value="Burundi"></option>
  <option value="Cabo Verde"></option>
  <option value="Cambodia"></option>
  <option value="Cameroon"></option>
  <option value="Canada"></option>
  <option value="Central African Republic"></option>
  <option value="Chad"></option>
  <option value="Chile"></option>
  <option value="China"></option>
  <option value="Colombia"></option>
  <option value="Comoros"></option>
  <option value="Congo (Congo-Brazzaville)"></option>
  <option value="Costa Rica"></option>
  <option value="C√¥te d‚ÄôIvoire"></option>
  <option value="Croatia"></option>
  <option value="Cuba"></option>
  <option value="Cyprus"></option>
  <option value="Czechia"></option>
  <option value="Democratic Republic of the Congo"></option>
  <option value="Denmark"></option>
  <option value="Djibouti"></option>
  <option value="Dominica"></option>
  <option value="Dominican Republic"></option>
  <option value="Ecuador"></option>
  <option value="Egypt"></option>
  <option value="El Salvador"></option>
  <option value="Equatorial Guinea"></option>
  <option value="Eritrea"></option>
  <option value="Estonia"></option>
  <option value="Eswatini"></option>
  <option value="Ethiopia"></option>
  <option value="Fiji"></option>
  <option value="Finland"></option>
  <option value="France"></option>
  <option value="Gabon"></option>
  <option value="Gambia"></option>
  <option value="Georgia"></option>
  <option value="Germany"></option>
  <option value="Ghana"></option>
  <option value="Greece"></option>
  <option value="Grenada"></option>
  <option value="Guatemala"></option>
  <option value="Guinea"></option>
  <option value="Guinea-Bissau"></option>
  <option value="Guyana"></option>
  <option value="Haiti"></option>
  <option value="Honduras"></option>
  <option value="Hungary"></option>
  <option value="Iceland"></option>
  <option value="India"></option>
  <option value="Indonesia"></option>
  <option value="Iran"></option>
  <option value="Iraq"></option>
  <option value="Ireland"></option>
  <option value="Israel"></option>
  <option value="Italy"></option>
  <option value="Jamaica"></option>
  <option value="Japan"></option>
  <option value="Jordan"></option>
  <option value="Kazakhstan"></option>
  <option value="Kenya"></option>
  <option value="Kiribati"></option>
  <option value="Kuwait"></option>
  <option value="Kyrgyzstan"></option>
  <option value="Laos"></option>
  <option value="Latvia"></option>
  <option value="Lebanon"></option>
  <option value="Lesotho"></option>
  <option value="Liberia"></option>
  <option value="Libya"></option>
  <option value="Liechtenstein"></option>
  <option value="Lithuania"></option>
  <option value="Luxembourg"></option>
  <option value="Madagascar"></option>
  <option value="Malawi"></option>
  <option value="Malaysia"></option>
  <option value="Maldives"></option>
  <option value="Mali"></option>
  <option value="Malta"></option>
  <option value="Marshall Islands"></option>
  <option value="Mauritania"></option>
  <option value="Mauritius"></option>
  <option value="Mexico"></option>
  <option value="Micronesia"></option>
  <option value="Moldova"></option>
  <option value="Monaco"></option>
  <option value="Mongolia"></option>
  <option value="Montenegro"></option>
  <option value="Morocco"></option>
  <option value="Mozambique"></option>
  <option value="Myanmar"></option>
  <option value="Namibia"></option>
  <option value="Nauru"></option>
  <option value="Nepal"></option>
  <option value="Netherlands"></option>
  <option value="New Zealand"></option>
  <option value="Nicaragua"></option>
  <option value="Niger"></option>
  <option value="Nigeria"></option>
  <option value="North Korea"></option>
  <option value="North Macedonia"></option>
  <option value="Norway"></option>
  <option value="Oman"></option>
  <option value="Pakistan"></option>
  <option value="Palau"></option>
  <option value="Panama"></option>
  <option value="Papua New Guinea"></option>
  <option value="Paraguay"></option>
  <option value="Peru"></option>
  <option value="Philippines"></option>
  <option value="Poland"></option>
  <option value="Portugal"></option>
  <option value="Qatar"></option>
  <option value="Romania"></option>
  <option value="Russia"></option>
  <option value="Rwanda"></option>
  <option value="Saint Kitts and Nevis"></option>
  <option value="Saint Lucia"></option>
  <option value="Saint Vincent and the Grenadines"></option>
  <option value="Samoa"></option>
  <option value="San Marino"></option>
  <option value="Sao Tome and Principe"></option>
  <option value="Saudi Arabia"></option>
  <option value="Senegal"></option>
  <option value="Serbia"></option>
  <option value="Seychelles"></option>
  <option value="Sierra Leone"></option>
  <option value="Singapore"></option>
  <option value="Slovakia"></option>
  <option value="Slovenia"></option>
  <option value="Solomon Islands"></option>
  <option value="Somalia"></option>
  <option value="South Africa"></option>
  <option value="South Korea"></option>
  <option value="South Sudan"></option>
  <option value="Spain"></option>
  <option value="Sri Lanka"></option>
  <option value="Sudan"></option>
  <option value="Suriname"></option>
  <option value="Sweden"></option>
  <option value="Switzerland"></option>
  <option value="Syria"></option>
  <option value="Taiwan"></option>
  <option value="Tajikistan"></option>
  <option value="Tanzania"></option>
  <option value="Thailand"></option>
  <option value="Timor-Leste"></option>
  <option value="Togo"></option>
  <option value="Tonga"></option>
  <option value="Trinidad and Tobago"></option>
  <option value="Tunisia"></option>
  <option value="Turkey"></option>
  <option value="Turkmenistan"></option>
  <option value="Tuvalu"></option>
  <option value="Uganda"></option>
  <option value="Ukraine"></option>
  <option value="United Arab Emirates"></option>
  <option value="United Kingdom"></option>
  <option value="United States"></option>
  <option value="Uruguay"></option>
  <option value="Uzbekistan"></option>
  <option value="Vanuatu"></option>
  <option value="Vatican City"></option>
  <option value="Venezuela"></option>
  <option value="Vietnam"></option>
  <option value="Yemen"></option>
  <option value="Zambia"></option>
  <option value="Zimbabwe"></option>
</datalist>


        <!-- SETTINGS -->
        <div id="settings-section" class="card-light rounded-xl shadow-xl p-6">
          <h2 class="font-display text-2xl font-bold accent-deep mb-4">‚öôÔ∏è Settings</h2>
          <div class="mb-6 flex flex-wrap gap-2 items-center">
            <span id="connection-status" class="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-full px-3 py-1 text-xs font-semibold text-gray-700">‚è≥ Connecting‚Ä¶</span>
            <span class="text-xs text-gray-600">If buttons don‚Äôt work, check Firebase Auth + Firestore Rules.</span>
          </div>


          <div class="mb-8">
            <h3 class="font-display text-lg font-bold accent-deep mb-4">Event</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <input id="event-name-input" type="text" class="border border-gray-300 rounded-lg" placeholder="Event name (shown as title)" />
              <button class="btn-primary rounded-lg font-semibold" onclick="saveEventName()">Save event name</button>
            </div>
            <p class="text-xs text-gray-600 mt-2">Tip: share the link with <span class="font-mono">?event=mitt-event</span> to create separate events.</p>
          </div>

          <hr class="my-8">

          <div class="mb-8">
            <h3 class="font-display text-lg font-bold accent-deep mb-4">Participants</h3>
            <div id="participants-list" class="space-y-2 mb-4"></div>
            <form id="participant-form" class="flex gap-2" onsubmit="handleAddParticipant(event)">
              <input type="text" id="participant-name" placeholder="Participantsns namn" class="flex-1 border border-gray-300 rounded-lg" required />
              <button type="submit" class="px-6 btn-primary rounded-lg font-semibold">+ Add</button>
            </form>
          </div>

          <hr class="my-8">

          <div class="mb-8">
            <h3 class="font-display text-lg font-bold accent-deep mb-4">Add wines</h3>
            <form id="wine-form" class="space-y-3" onsubmit="handleAddWine(event)">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <input type="number" id="wine-number" placeholder="Wine number" class="border border-gray-300 rounded-lg" required />
                <input type="text" id="wine-name" placeholder="Wine name" class="border border-gray-300 rounded-lg" required />
                <input type="text" id="wine-grape" placeholder="Grape" class="border border-gray-300 rounded-lg" required />
                <input type="number" id="wine-price" placeholder="Price (‚Ç¨)" class="border border-gray-300 rounded-lg"  step="0.1" required />
                <input type="text" id="wine-country" placeholder="Country" class="border border-gray-300 rounded-lg" required / list="country-list">
              </div>
              <button type="submit" class="w-full btn-primary rounded-lg font-semibold">‚úì Add wine</button>
            </form>

            <h3 class="font-display text-lg font-bold accent-deep mt-8 mb-4">Added wines</h3>
            <div id="wines-list" class="space-y-2"></div>
          </div>

          <hr class="my-8">

          <div class="mb-8">
            <div class="flex items-center justify-between gap-3 mb-2">
              <h3 class="font-display text-lg font-bold accent-deep">Quiz questions</h3>
              <button class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-semibold" onclick="toggleQuizEditor()">‚úèÔ∏è Edit questions</button>
            </div>
            <div id="quiz-editor-panel" class="hidden mt-3">
            <p class="text-xs text-gray-600 mb-4">You can create your own questions here. They are saved per event and synced live.</p>
            <div id="quiz-editor" class="space-y-3"></div>
            <div class="flex gap-2 mt-4">
              <button class="flex-1 btn-primary rounded-lg font-semibold" onclick="addEmptyQuestion()">+ New question</button>
              <button class="flex-1 bg-white border border-gray-300 rounded-lg font-semibold" onclick="saveQuizQuestions()">Save quiz</button>
            </div>
          
            </div>
</div>

          <hr class="my-8">

          <div>
            <h3 class="font-display text-lg font-bold accent-deep mb-4">Reset data</h3>
            <div class="flex gap-2">
              <button onclick="resetTastings()" class="flex-1 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold py-2">Reset tastings</button>
              <button onclick="resetQuiz()" class="flex-1 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold py-2">Reset quiz</button>
            </div>
          </div>
        </div>

        <!-- TASTING -->
        <div id="tasting-section" class="hidden card-light rounded-xl shadow-xl p-6">
          <h2 class="font-display text-2xl font-bold accent-deep mb-6">üç∑ Tasting</h2>
          <div id="tasting-start" class="space-y-4">
            <p class="text-gray-700">Choose a participant and a wine to start tasting</p>
            <select id="tasting-participant" class="w-full border border-gray-300 rounded-lg" required>
              <option value="">-- Select participant --</option>
            </select>
            <select id="tasting-wine" class="w-full border border-gray-300 rounded-lg" required>
              <option value="">-- Select wine --</option>
            </select>
            <button onclick="startTasting()" class="w-full btn-primary rounded-lg font-semibold">Start tasting</button>
          </div>

          <div id="tasting-form" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-lg">
              <h3 id="tasting-wine-title" class="font-display text-xl font-bold accent-deep mb-2"></h3>
            </div>

            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Guess the country</label>
              <input type="text" id="tasting-guess-country" placeholder="e.g. France" class="w-full border border-gray-300 rounded-lg" required / list="country-list">
            </div>
            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Guess the grape</label>
              <input type="text" id="tasting-guess-grape" placeholder="e.g. Pinot Noir" class="w-full border border-gray-300 rounded-lg" required />
            </div>
            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Guess the price (‚Ç¨)</label>
              <input type="number" id="tasting-guess-price" placeholder="e.g. 12.5" class="w-full border border-gray-300 rounded-lg"  step="0.1" required />
            </div>

            <hr class="my-4">

            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Aroma (how strong is the smell?)</label>
              <div class="flex gap-2">
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('aroma','Low', event)">Low</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('aroma','Medium', event)">Medium</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('aroma','High', event)">High</button>
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Body (how heavy does it feel?)</label>
              <div class="flex gap-2">
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('body','Light', event)">Light</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('body','Medium', event)">Medium</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('body','Full-bodied', event)">Full-bodied</button>
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Acidity (freshness)</label>
              <div class="flex gap-2">
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('acidity','Low', event)">Low</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('acidity','Medium', event)">Medium</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('acidity','High', event)">High</button>
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Sweetness (how sweet is it?)</label>
              <div class="flex gap-2">
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('sweetness','Dry', event)">Dry</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('sweetness','Off-dry', event)">Off-dry</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('sweetness','Sweet', event)">Sweet</button>
              </div>
            </div>

            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Overall rating</label>
              <div class="star-rating" id="rating-stars"></div>
            </div>

            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Would you buy it again?</label>
              <div class="flex gap-2">
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('buy_again','Yes', event)">Yes</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('buy_again','Maybe', event)">Maybe</button>
                <button type="button" class="option-btn flex-1" onclick="selectTastingOption('buy_again','No', event)">No</button>
              </div>
            </div>

            <div>
              <label class="block text-xs font-semibold accent-deep mb-2">Your notes</label>
              <textarea id="tasting-notes" placeholder="Write what you think about this wine..." class="w-full border border-gray-300 rounded-lg"></textarea>
            </div>

            <div class="flex gap-2">
              <button onclick="submitTasting()" class="flex-1 btn-primary rounded-lg font-semibold py-3">‚úì Save tasting</button>
              <button onclick="cancelTasting()" class="flex-1 bg-gray-300 text-gray-700 rounded-lg font-semibold py-3">‚ùå Cancel</button>
            </div>
          </div>
        </div>

        <!-- QUIZ -->
        <div id="quiz-section" class="hidden card-light rounded-xl shadow-xl p-6">
          <h2 class="font-display text-2xl font-bold accent-deep mb-6">üß† Quiz</h2>
          <div id="quiz-start" class="space-y-4">
            <p class="text-gray-700">Choose a participant to start the quiz</p>
            <select id="quiz-participant" class="w-full border border-gray-300 rounded-lg" required>
              <option value="">-- Select participant --</option>
            </select>
            <button onclick="startQuiz()" class="w-full btn-primary rounded-lg font-semibold">Start quiz</button>
          </div>
          <div id="quiz-questions" class="hidden space-y-6"></div>
          <div id="quiz-submit" class="hidden mt-6">
            <button onclick="submitQuiz()" class="w-full btn-primary rounded-lg font-semibold text-lg py-3">üì§ Submit answers</button>
          </div>
        </div>

        <!-- TASTING RESULTS -->
        <div id="tasting-results-section" class="hidden card-light rounded-xl shadow-xl p-6">
          <h2 class="font-display text-2xl font-bold accent-deep mb-6">üçá Wine tasting results</h2>
          <div id="tasting-results-content" class="space-y-6"></div>
          <button onclick="toggleWineReveal(event)" class="w-full mt-8 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold py-3">üé≠ Reveal wines</button>
          <div id="wine-reveal" class="hidden mt-6 space-y-3"></div>
        </div>

        <!-- QUIZ RESULTS -->
        <div id="quiz-results-section" class="hidden card-light rounded-xl shadow-xl p-6">
          <h2 class="font-display text-2xl font-bold accent-deep mb-6">üèÜ Quiz results</h2>
          <div id="quiz-results-content" class="space-y-6"></div>
        </div>

      </div>
    </div>

    <div id="toast" class="fixed bottom-4 left-4 right-4 sm:left-auto sm:right-auto px-6 py-3 bg-green-600 text-white rounded-full shadow-lg opacity-0 transition-all z-40"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    // --- Visible error banner (so issues aren't hidden in Console) ---
    function showFatal(msg) {
      const el = document.getElementById('debug-banner');
      if (el) { el.classList.remove('hidden'); el.textContent = msg; }
    }
    window.addEventListener('error', (e) => showFatal('‚ö†Ô∏è App error: ' + String(e.message || e.error || e)));
    window.addEventListener('unhandledrejection', (e) => showFatal('‚ö†Ô∏è Promise error: ' + String(e.reason || e)));
    
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, deleteDoc, setDoc, getDoc,
      onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    function getEventId() {
      // Supports:
      //  - ?event=slalomgrand
      //  - ?event.slalomgrand   (legacy)
      const qs = location.search || "";
      const p = new URLSearchParams(qs);
      let raw = (p.get("event") || "").trim();
      if (!raw) {
        // legacy: ?event.NAME  (no =)
        const legacy = qs.startsWith("?event.") ? qs.slice("?event.".length) : "";
        raw = legacy.split("&")[0].trim();
      }
      raw = (raw || "default").toLowerCase();
      // keep a-z 0-9 _ -
      return raw.replace(/[^a-z0-9_-]/g, "");
    }
    const EVENT_ID = getEventId();
    document.getElementById("event-subtitle").textContent = `Event: ${EVENT_ID}`;

    const firebaseConfig = {
      apiKey: "AIzaSyDmYU8t0-DSKHZlx6qbMBg0kaUVSqYfpu8",
      authDomain: "winetasting-b44b0.firebaseapp.com",
      projectId: "winetasting-b44b0",
      storageBucket: "winetasting-b44b0.firebasestorage.app",
      messagingSenderId: "181635666044",
      appId: "1:181635666044:web:3c12a0b5eddeca6d98b9f9",
      measurementId: "G-H7B9XB6G5K"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const itemsCol = collection(db, "events", EVENT_ID, "items");
    const metaDoc = doc(db, "events", EVENT_ID, "meta", "config");

    const defaultConfig = { event_title: "üç∑ Wine Tasting" };

    let allItems = [];
    let participants = [];
    let wines = [];
    let tastings = [];
    let quizResults = [];
    let quizQuestions = [];

    let currentParticipant = null;
    let currentWine = null;
    let tastingData = {};
    let currentOverall rating = 0;
    let quizAnswers = {};

    const COUNTRIES = ["Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Congo-Brazzaville)", "Costa Rica", "C\u00f4te d\u2019Ivoire", "Croatia", "Cuba", "Cyprus", "Czechia", "Democratic Republic of the Congo", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"];
    const COUNTRY_SET = new Set(COUNTRIES.map(c => c.toLowerCase()));


// Accept common aliases (and some Swedish names) and normalize to the canonical country name.
const COUNTRY_CANON = new Map(COUNTRIES.map(c => [c.toLowerCase(), c]));
const COUNTRY_ALIASES = new Map(Object.entries({
  // Common English aliases
  "usa": "United States",
  "u.s.a.": "United States",
  "us": "United States",
  "u.s.": "United States",
  "uk": "United Kingdom",
  "u.k.": "United Kingdom",
  "england": "United Kingdom",
  "scotland": "United Kingdom",
  "wales": "United Kingdom",
  "czech republic": "Czechia",
  "ivory coast": "C√¥te d‚ÄôIvoire",
  "cote d'ivoire": "C√¥te d‚ÄôIvoire",
  "cote d‚Äôivoire": "C√¥te d‚ÄôIvoire",
  "south korea": "South Korea",
  "north korea": "North Korea",
  "uae": "United Arab Emirates",

  // Swedish -> English (helpful if people type in Swedish)
  "frankrike": "France",
  "italien": "Italy",
  "spanien": "Spain",
  "tyskland": "Germany",
  "√∂sterrike": "Austria",
  "portugal": "Portugal",
  "grekland": "Greece",
  "ungern": "Hungary",
  "sydafrika": "South Africa",
  "argentina": "Argentina",
  "chile": "Chile",
  "australien": "Australia",
  "nya zeeland": "New Zealand",
  "nyazeeland": "New Zealand",
  "usa": "United States",
  "sverige": "Sweden"
}));

function normalizeCountryInput(raw) {
  const s = String(raw || "").trim();
  if (!s) return "";
  const key = s.toLowerCase();
  const aliased = COUNTRY_ALIASES.get(key);
  const candidate = (aliased || s).trim();
  const canon = COUNTRY_CANON.get(candidate.toLowerCase());
  return canon || "";
}


    const DEFAULT_QUESTIONS = [
  {
    id: 1,
    q: "1) Which country produces the most wine in the world?",
    opts: [["1","Spain"],["X","Italy"],["2","France"]],
    correct: "X"
  },
  {
    id: 2,
    q: "2) What is the main grape in red wine from Barolo?",
    opts: [["1","Barbera"],["X","Sangiovese"],["2","Nebbiolo"]],
    correct: "2"
  },
  {
    id: 3,
    q: "3) What does \"Sec\" mean on a French wine label?",
    opts: [["1","Dry"],["X","Off-dry / semi-sweet"],["2","Very sweet"]],
    correct: "X"
  },
  {
    id: 4,
    q: "4) Which wine region is most famous for Riesling?",
    opts: [["1","Rioja"],["X","Bordeaux"],["2","Mosel"]],
    correct: "2"
  },
  {
    id: 5,
    q: "5) What happens during malolactic fermentation?",
    opts: [["1","Sugar turns into alcohol"],["X","Malic acid turns into lactic acid"],["2","Alcohol turns into vinegar"]],
    correct: "X"
  },
  {
    id: 6,
    q: "6) Which country does Malbec originally come from?",
    opts: [["1","Argentina"],["X","Chile"],["2","France"]],
    correct: "2"
  },
  {
    id: 7,
    q: "7) What does oak aging most often add to the flavour?",
    opts: [["1","More tannin, spice and vanilla notes"],["X","Lower alcohol"],["2","Less acidity"]],
    correct: "1"
  },
  {
    id: 8,
    q: "8) Cava is produced mainly in‚Ä¶",
    opts: [["1","Italy"],["X","Spain"],["2","Portugal"]],
    correct: "X"
  },
  {
    id: 9,
    q: "9) Prosecco is made primarily from which grape?",
    opts: [["1","Glera"],["X","Trebbiano"],["2","Pinot Grigio"]],
    correct: "1"
  },
  {
    id: 10,
    q: "10) Which climate usually produces wines with higher acidity and lower alcohol?",
    opts: [["1","Warm climate"],["X","Cool climate"],["2","Tropical climate"]],
    correct: "X"
  },
  {
    id: 11,
    q: "11) What does \"Grand Cru\" mean in Burgundy?",
    opts: [["1","A special grape"],["X","A storage method"],["2","The highest vineyard classification"]],
    correct: "2"
  },
  {
    id: 12,
    q: "12) What does longer skin contact with dark grapes usually do?",
    opts: [["1","Darker colour and more tannin"],["X","Lighter colour"],["2","No difference"]],
    correct: "1"
  },
  {
    id: 13,
    q: "13) What is typical for Sauvignon Blanc from New Zealand?",
    opts: [["1","Buttery, oaky notes"],["X","High acidity and gooseberry/citrus aromas"],["2","Very high tannin"]],
    correct: "X"
  },
  {
    id: 14,
    q: "14) How is ros√© most often made?",
    opts: [["1","By mixing red and white wine"],["X","Long oak aging"],["2","Short skin contact with dark grapes"]],
    correct: "2"
  },
  {
    id: 15,
    q: "15) What does \"Reserva\" generally mean in Rioja (Spain)?",
    opts: [["1","Higher aging requirements than Crianza"],["X","Organic wine"],["2","Low alcohol"]],
    correct: "1"
  }
];

    function escapeHtml(str) {
      return String(str ?? "").replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    }

    function getPriceRange(priceStr) {
  const price = parseFloat(priceStr);
  if (isNaN(price)) return null;

  const ranges = [
    [1, 5],
    [5.1, 10],
    [10.1, 15],
    [15.1, 20],
    [20.1, 25],
    [25.1, 30],
    [30.1, 35],
    [35.1, 40],
    [40.1, 45],
    [45.1, 50],
    [50.1, 55],
    [55.1, 60],
    [60.1, 65]
  ];

  for (const [min, max] of ranges) {
    if (price >= min && price <= max) return `${min}-${max}`;
  }
  if (price >= 65.1) return "65.1+";
  return null;
}

    function showToast(msg, type = "success") {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = `fixed bottom-4 left-4 right-4 sm:left-auto sm:right-auto px-6 py-3 ${type === "error" ? "bg-red-600" : "bg-green-600"} text-white rounded-full shadow-lg transition-all z-40`;
      toast.style.opacity = "1";
      setTimeout(() => (toast.style.opacity = "0"), 3000);
    }

    function updateNav(active) {
      const btns = { settings: "btn-settings", tasting: "btn-tasting", quiz: "btn-quiz", "tasting-results":"btn-tasting-results", "quiz-results":"btn-quiz-results" };
      Object.entries(btns).forEach(([key, id]) => {
        const btn = document.getElementById(id);
        if (key === active) {
          btn.classList.add("btn-primary");
          btn.classList.remove("bg-white/20");
        } else {
          btn.classList.remove("btn-primary");
          btn.classList.add("bg-white/20");
        }
      });
    }

    window.showSettings = function() {
      document.getElementById("settings-section").classList.remove("hidden");
      document.getElementById("tasting-section").classList.add("hidden");
      document.getElementById("quiz-section").classList.add("hidden");
      document.getElementById("tasting-results-section").classList.add("hidden");
      document.getElementById("quiz-results-section").classList.add("hidden");
      updateNav("settings");
      renderParticipants();
      renderWinesList();
      renderQuizEditor();
    };

    window.showTasting = function() {
      document.getElementById("settings-section").classList.add("hidden");
      document.getElementById("tasting-section").classList.remove("hidden");
      document.getElementById("quiz-section").classList.add("hidden");
      document.getElementById("tasting-results-section").classList.add("hidden");
      document.getElementById("quiz-results-section").classList.add("hidden");
      updateNav("tasting");
      renderTastingSelects();
    };

    window.showQuiz = function() {
      document.getElementById("settings-section").classList.add("hidden");
      document.getElementById("tasting-section").classList.add("hidden");
      document.getElementById("quiz-section").classList.remove("hidden");
      document.getElementById("tasting-results-section").classList.add("hidden");
      document.getElementById("quiz-results-section").classList.add("hidden");
      updateNav("quiz");
      renderQuizParticipants();
    };

    window.showTastingResults = function() {
      document.getElementById("settings-section").classList.add("hidden");
      document.getElementById("tasting-section").classList.add("hidden");
      document.getElementById("quiz-section").classList.add("hidden");
      document.getElementById("tasting-results-section").classList.remove("hidden");
      document.getElementById("quiz-results-section").classList.add("hidden");
      updateNav("tasting-results");
      renderTastingResultsPage();
    };

    window.showQuizResults = function() {
      document.getElementById("settings-section").classList.add("hidden");
      document.getElementById("tasting-section").classList.add("hidden");
      document.getElementById("quiz-section").classList.add("hidden");
      document.getElementById("tasting-results-section").classList.add("hidden");
      document.getElementById("quiz-results-section").classList.remove("hidden");
      updateNav("quiz-results");
      renderQuizResultsPage();
    };

    async function ensureSignedIn() {
      if (auth.currentUser) return auth.currentUser;
      await signInAnonymously(auth);
      return auth.currentUser;
    }

    async function createItem(data) {
      await ensureSignedIn();
      const ref = await addDoc(itemsCol, { ...data, createdAt: Date.now() });
      return ref.id;
    }

    async function deleteItemById(id) {
      await ensureSignedIn();
      await deleteDoc(doc(itemsCol, id));
    }

    window.deleteItem = async function(id) {
      try { await deleteItemById(id); }
      catch (e) { console.error(e); showToast("Couldn't delete (check Firestore Rules)", "error"); }
    };

    async function loadEventConfig() {
      try {
        const snap = await getDoc(metaDoc);
        const cfg = snap.exists() ? snap.data() : {};
        const title = cfg.event_title || defaultConfig.event_title;
        document.getElementById("event-title").textContent = title;
        document.getElementById("event-name-input").value = title;
      } catch (e) {
        console.warn(e);
      }
    }

    window.saveEventName = async function() {
      const title = document.getElementById("event-name-input").value.trim() || defaultConfig.event_title;
      try {
        await ensureSignedIn();
        await setDoc(metaDoc, { event_title: title }, { merge: true });
        showToast("Event name saved!");
      } catch (e) {
        console.error(e);
        showToast("Couldn't save event name (check Rules)", "error");
      }
    };

    window.handleAddParticipant = async function(e) {
      e.preventDefault();
      const name = document.getElementById("participant-name").value.trim();
      if (!name) return;
      try {
        await createItem({ type: "participant", participant_name: name });
        document.getElementById("participant-name").value = "";
        showToast("Participants tillagd!");
      } catch (err) {
        console.error(err);
        showToast("Couldn't add participant (check Rules)", "error");
      }
    };

    window.handleAddWine = async function(e) {
      e.preventDefault();
      const payload = {
        type: "wine",
        wine_number: parseInt(document.getElementById("wine-number").value),
        wine_name: document.getElementById("wine-name").value.trim(),
        grape: document.getElementById("wine-grape").value.trim(),
        price: parseFloat(document.getElementById("wine-price").value),
        country: document.getElementById("wine-country").value.trim(),
      };
      // Validate country (avoid typos)
      const normalizedCountry = normalizeCountryInput(payload.country);
      if (payload.country && !normalizedCountry) {
        showToast("Please pick a country from the list (e.g. France, Italy). You can also type USA/UK.", "error");
        return;
      }
      if (normalizedCountry) payload.country = normalizedCountry;

      try {
        await createItem(payload);
        document.getElementById("wine-form").reset();
        showToast("Wine added!");
      } catch (err) {
        console.error(err);
        showToast("Couldn't add wine (check Rules)", "error");
      }
    };

    function renderParticipants() {
      const container = document.getElementById("participants-list");
      const parts = participants.slice().sort((a,b) => (a.participant_name||"").localeCompare(b.participant_name||""));
      container.innerHTML = parts.map(p => `
        <div class="flex justify-between items-center bg-white p-3 rounded-lg">
          <span class="accent-deep font-semibold">${escapeHtml(p.participant_name)}</span>
          <button class="text-red-600" onclick="deleteItem('${p.__id}')">‚úï</button>
        </div>
      `).join("");
    }

    function renderWinesList() {
      const container = document.getElementById("wines-list");
      const wineList = wines.slice().sort((a,b) => (a.wine_number||0) - (b.wine_number||0));
      container.innerHTML = wineList.map(w => `
        <div class="flex justify-between items-center bg-white p-3 rounded-lg">
          <span class="accent-deep font-semibold">Wine ${w.wine_number}</span>
          <button class="text-red-600" onclick="deleteItem('${w.__id}')">‚úï</button>
        </div>
      `).join("");
    }

    function renderTastingSelects() {
      const participantSelect = document.getElementById("tasting-participant");
      const wineSelect = document.getElementById("tasting-wine");
      const parts = participants.slice().sort((a,b)=> (a.participant_name||"").localeCompare(b.participant_name||""));
      const wineList = wines.slice().sort((a,b)=> (a.wine_number||0) - (b.wine_number||0));

      participantSelect.innerHTML =
        '<option value="">-- Select participant --</option>' +
        parts.map(p => `<option value="${escapeHtml(p.participant_name)}">${escapeHtml(p.participant_name)}</option>`).join("");

      wineSelect.innerHTML =
        '<option value="">-- Select wine --</option>' +
        wineList.map(w => `<option value="${w.__id}">Wine ${w.wine_number}</option>`).join("");
    }

    window.startTasting = function() {
      const participantName = document.getElementById("tasting-participant").value;
      const wineId = document.getElementById("tasting-wine").value;
      if (!participantName || !wineId) { showToast("Select participant and wine", "error"); return; }

      const wine = wines.find(w => w.__id === wineId);
      if (!wine) { showToast("Can't find the wine (reload)", "error"); return; }

      currentParticipant = participantName;
      currentWine = wine;
      tastingData = {};
      currentOverall rating = 0;

      document.getElementById("tasting-start").classList.add("hidden");
      document.getElementById("tasting-form").classList.remove("hidden");
      document.getElementById("tasting-wine-title").textContent = `Wine ${wine.wine_number}`;
      document.getElementById("tasting-guess-country").value = "";
      document.getElementById("tasting-guess-grape").value = "";
      document.getElementById("tasting-guess-price").value = "";
      document.getElementById("tasting-notes").value = "";
      document.querySelectorAll("#tasting-form .option-btn").forEach(btn => btn.classList.remove("selected"));

      renderStars();
    };

    function renderStars() {
      const container = document.getElementById("rating-stars");
      container.innerHTML = Array.from({length:5}, (_,i) => `
        <button type="button" class="star-btn" onclick="setOverall rating(${i+1})">${i < currentOverall rating ? "‚òÖ" : "‚òÜ"}</button>
      `).join("");
    }

    window.setOverall rating = function(rating) {
      currentOverall rating = rating;
      tastingData.rating = rating;
      renderStars();
    };

    window.selectTastingOption = function(field, value, evt) {
      tastingData[field] = value;
      const buttons = evt.target.parentElement.querySelectorAll(".option-btn");
      buttons.forEach(btn => btn.classList.remove("selected"));
      evt.target.classList.add("selected");
    };

    window.submitTasting = async function() {
      if (!currentParticipant || !currentWine) return;
      if (!tastingData.aroma || !tastingData.body || !tastingData.acidity || !tastingData.sweetness || !tastingData.buy_again) {
        showToast("Fill in all fields", "error");
        return;
      }
      // Validate guessed country (avoid typos)
const guessedCountry = document.getElementById("tasting-guess-country").value.trim();
const normalizedGuess = normalizeCountryInput(guessedCountry);
            if (guessedCountry && !normalizedGuess) {
  showToast("Please pick a country from the list (you can also type USA/UK).", "error");
  return;
}
try {
        await createItem({
          type: "tasting",
          participant_name: currentParticipant,
          wine_number: currentWine.wine_number,
          guess_country: (normalizedGuess || document.getElementById("tasting-guess-country").value.trim()),
          guess_grape: document.getElementById("tasting-guess-grape").value.trim(),
          guess_price: String(document.getElementById("tasting-guess-price").value).trim(),
          aroma: tastingData.aroma,
          body: tastingData.body,
          acidity: tastingData.acidity,
          sweetness: tastingData.sweetness,
          rating: tastingData.rating || 0,
          buy_again: tastingData.buy_again,
          notes: document.getElementById("tasting-notes").value.trim()
        });
        showToast("Tasting saved!");
        cancelTasting();
      } catch (e) {
        console.error(e);
        showToast("Couldn't save tasting (check Rules)", "error");
      }
    };

    window.cancelTasting = function() {
      document.getElementById("tasting-start").classList.remove("hidden");
      document.getElementById("tasting-form").classList.add("hidden");
      document.getElementById("tasting-participant").value = "";
      document.getElementById("tasting-wine").value = "";
      currentParticipant = null;
      currentWine = null;
      tastingData = {};
      currentOverall rating = 0;
    };

    function getQuestionsForRun() {
      const qs = (quizQuestions && quizQuestions.length ? quizQuestions : DEFAULT_QUESTIONS).map((q, idx) => {
        const id = q.id ?? (idx+1);
        const opts = Array.isArray(q.opts) ? q.opts : [["1",""],["X",""],["2",""]];
        const correct = q.correct ?? "1";
        return { id, q: q.q ?? "", opts, correct };
      });
      return qs;
    }

    function renderQuizParticipants() {
      const select = document.getElementById("quiz-participant");
      const parts = participants.slice().sort((a,b)=> (a.participant_name||"").localeCompare(b.participant_name||""));
      select.innerHTML = '<option value="">-- Select participant --</option>' + parts.map(p => `<option value="${escapeHtml(p.participant_name)}">${escapeHtml(p.participant_name)}</option>`).join("");
    }

    window.startQuiz = function() {
      const selected = document.getElementById("quiz-participant").value;
      if (!selected) { showToast("Select deltagare", "error"); return; }

      currentParticipant = selected;
      quizAnswers = {};

      document.getElementById("quiz-start").classList.add("hidden");
      document.getElementById("quiz-questions").classList.remove("hidden");
      document.getElementById("quiz-submit").classList.remove("hidden");
      renderQuizQuestions();
    };

    function renderQuizQuestions() {
      const container = document.getElementById("quiz-questions");
      const QUESTIONS = getQuestionsForRun();
      container.innerHTML = QUESTIONS.map(q => `
        <div class="bg-white p-4 rounded-lg" data-q-id="${q.id}">
          <p class="font-semibold text-gray-800 mb-3">${escapeHtml(q.q)}</p>
          <div class="space-y-2">
            ${q.opts.map(([key,value]) => `
              <button type="button" class="option-btn w-full text-left rounded-lg" data-answer="${escapeHtml(key)}" onclick="selectQuizAnswer(${q.id}, '${escapeHtml(key)}', event)">
                <span class="font-bold mr-3">${escapeHtml(key)}</span>${escapeHtml(value)}
              </button>
            `).join("")}
          </div>
        </div>
      `).join("");
    }

    window.selectQuizAnswer = function(questionId, answer, evt) {
      quizAnswers[questionId] = answer;
      const container = evt.target.closest("[data-q-id]");
      container.querySelectorAll(".option-btn").forEach(btn => btn.classList.remove("selected"));
      evt.target.closest(".option-btn").classList.add("selected");
    };

    window.submitQuiz = async function() {
      const QUESTIONS = getQuestionsForRun();
      let score = 0;
      QUESTIONS.forEach(q => { if (quizAnswers[q.id] === q.correct) score++; });

      try {
        await createItem({
          type: "quiz",
          participant_name: currentParticipant,
          quiz_answers: JSON.stringify(quizAnswers),
          quiz_score: score
        });
        showToast(`Done! You got ${score}/${QUESTIONS.length} correct!`);
        currentParticipant = null;
        quizAnswers = {};
        document.getElementById("quiz-start").classList.remove("hidden");
        document.getElementById("quiz-questions").classList.add("hidden");
        document.getElementById("quiz-submit").classList.add("hidden");
        document.getElementById("quiz-participant").value = "";
      } catch (e) {
        console.error(e);
        showToast("Couldn't save quiz (permissions/rules).", "error");
      }
    };

    function renderRankedList(items, getLabel, getScoreText) {
      const medals = ["ü•á","ü•à","ü•â"];
      let html = "";

      const top3 = items.slice(0, 3);
      if (top3.length) {
        html += '<div class="podium">';
        top3.forEach((it, idx) => {
          html += `
            <div class="podium-position">
              <div class="podium-medal">${medals[idx]}</div>
              <p class="font-bold accent-deep">${escapeHtml(getLabel(it))}</p>
              <p class="text-2xl font-display font-bold accent-deep">${escapeHtml(getScoreText(it))}</p>
              <p class="text-xs text-gray-500 mt-1">#${idx+1}</p>
            </div>
          `;
        });
        html += "</div>";
      }

      if (items.length > 3) {
        html += '<div class="bg-white rounded-lg overflow-hidden border border-gray-200">';
        html += '<div class="grid grid-cols-12 gap-2 px-4 py-2 text-xs font-semibold text-gray-600 bg-gray-50"><div class="col-span-2">Place</div><div class="col-span-7">Name</div><div class="col-span-3 text-right">Result</div></div>';
        items.slice(3).forEach((it, i) => {
          const place = i + 4;
          html += `<div class="grid grid-cols-12 gap-2 px-4 py-3 border-t">
            <div class="col-span-2 font-semibold text-gray-700">${place}</div>
            <div class="col-span-7 text-gray-800">${escapeHtml(getLabel(it))}</div>
            <div class="col-span-3 text-right font-semibold">${escapeHtml(getScoreText(it))}</div>
          </div>`;
        });
        html += "</div>";
      }

      return html;
    }

    
    
    function analyzeWineTastes() {
      // Aggregate subjective attributes per wine and pick "most common" winners
      const analysis = { sweetest:null, driest:null, fullest:null, lightest:null, mostAroma (how strong is the smell?):null, leastAroma (how strong is the smell?):null, mostAcidity (freshness):null, leastAcidity (freshness):null };
      const perWine = {};
      (wines||[]).filter(w=>w.type==='wine').forEach(w=>{
        perWine[w.wine_number] = { sweetness:[], body:[], aroma:[], acidity:[] };
      });
      (tastings||[]).forEach(t=>{
        const bucket = perWine[t.wine_number];
        if(!bucket) return;
        if(t.sweetness) bucket.sweetness.push(t.sweetness);
        if(t.body) bucket.body.push(t.body);
        if(t.aroma) bucket.aroma.push(t.aroma);
        if(t.acidity) bucket.acidity.push(t.acidity);
      });
      const count = (arr,val)=>arr.filter(x=>x===val).length;
      let best = (metric,val,cmp='max')=>{
        let bestWine=null, bestCount=-1;
        Object.entries(perWine).forEach(([wineNum,data])=>{
          const c=count(data[metric], val);
          if(cmp==='max' ? c>bestCount : c<bestCount){
            bestCount=c; bestWine=wineNum;
          }
        });
        return bestWine;
      };
      // For "min" style we still want the wine with most votes for that opposite label
      analysis.sweetest = (()=>{let w=null,bc=-1;Object.entries(perWine).forEach(([n,d])=>{const c=count(d.sweetness,'Sweet'); if(c>bc){bc=c;w=n}});return w;})();
      analysis.driest   = (()=>{let w=null,bc=-1;Object.entries(perWine).forEach(([n,d])=>{const c=count(d.sweetness,'Dry'); if(c>bc){bc=c;w=n}});return w;})();
      analysis.fullest  = (()=>{let w=null,bc=-1;Object.entries(perWine).forEach(([n,d])=>{const c=count(d.body,'Full-bodied'); if(c>bc){bc=c;w=n}});return w;})();
      analysis.lightest = (()=>{let w=null,bc=-1;Object.entries(perWine).forEach(([n,d])=>{const c=count(d.body,'Light'); if(c>bc){bc=c;w=n}});return w;})();
      analysis.mostAroma (how strong is the smell?)= (()=>{let w=null,bc=-1;Object.entries(perWine).forEach(([n,d])=>{const c=count(d.aroma,'High'); if(c>bc){bc=c;w=n}});return w;})();
      analysis.leastAroma (how strong is the smell?)=(()=>{let w=null,bc=-1;Object.entries(perWine).forEach(([n,d])=>{const c=count(d.aroma,'Low'); if(c>bc){bc=c;w=n}});return w;})();
      analysis.mostAcidity (freshness)=(()=>{let w=null,bc=-1;Object.entries(perWine).forEach(([n,d])=>{const c=count(d.acidity,'High'); if(c>bc){bc=c;w=n}});return w;})();
      analysis.leastAcidity (freshness)=(()=>{let w=null,bc=-1;Object.entries(perWine).forEach(([n,d])=>{const c=count(d.acidity,'Low'); if(c>bc){bc=c;w=n}});return w;})();
      return analysis;
    }

function renderTastingResultsPage() {
      const container = document.getElementById('tasting-results-content');

      const parts = participants.slice().sort((a, b) => a.participant_name.localeCompare(b.participant_name));
      const totalParticipants = parts.length;

      if (tastings.length === 0) {
        container.innerHTML = '<p class="text-gray-600">No tastings yet</p>';
        return;
      }

      // Avg rating per wine
      const winesByOverall rating = {};
      tastings.forEach(t => {
        if (!winesByOverall rating[t.wine_number]) winesByOverall rating[t.wine_number] = { total: 0, count: 0 };
        winesByOverall rating[t.wine_number].total += Number(t.rating || 0);
        winesByOverall rating[t.wine_number].count += 1;
      });

      const ratedWines = Object.entries(winesByOverall rating)
        .map(([wineNum, data]) => {
          const wine = wines.find(w => String(w.wine_number) === String(wineNum));
          const avg = data.count ? (data.total / data.count) : 0;

          // Participation per wine (unique participants who submitted)
          const respondedSet = new Set(
            tastings
              .filter(t => String(t.wine_number) === String(wineNum))
              .map(t => String(t.participant_name || '').trim())
              .filter(Boolean)
          );

          const responded = Array.from(respondedSet).sort((a, b) => a.localeCompare(b));
          const missing = parts
            .map(p => p.participant_name)
            .filter(n => !respondedSet.has(String(n).trim()));

          return {
            wine_number: wineNum,
            avg_rating: avg,
            tasted_count: responded.length,
            total_participants: totalParticipants,
            responded,
            missing,
            // hidden details
            wine_name: wine?.wine_name || '',
            grape: wine?.grape || '',
            country: wine?.country || '',
            price: wine?.price ?? ''
          };
        })
        .sort((a, b) => b.avg_rating - a.avg_rating);

      const medals = ['ü•á', 'ü•à', 'ü•â'];

      let html = '';
      html += '<div class="mb-6">';
      html += '<h3 class="font-display text-xl font-bold accent-deep mb-4">‚≠ê Wine ranking by rating</h3>';

      ratedWines.forEach((w, i) => {
        const rank = i + 1;
        const medal = rank <= 3 ? medals[rank - 1] : '';
        const respondedText = `${w.tasted_count} av ${w.total_participants} har svarat`;

        html += `
          <div class="bg-white rounded-lg p-4 mb-3 border border-gray-200">
            <div class="flex justify-between items-start gap-4">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <span class="text-lg">${medal || `<span class="inline-block w-7 text-center font-bold text-gray-500">${rank}</span>`}</span>
                  <p class="font-bold accent-deep text-lg">Wine ${escapeHtml(String(w.wine_number))}</p>
                </div>
                <button type="button"
                        class="mt-1 text-sm text-gray-700 underline decoration-dotted"
                        onclick="toggleWineParticipants('${escapeHtml(String(w.wine_number))}')">
                  ${escapeHtml(respondedText)}
                </button>
              </div>
              <div class="flex items-center gap-2 shrink-0">
                <span class="text-2xl">‚≠ê</span>
                <span class="font-display font-bold accent-deep text-2xl">${Number(w.avg_rating).toFixed(1)}</span>
              </div>
            </div>

            <div id="wine-participants-${escapeHtml(String(w.wine_number))}" class="hidden mt-3 bg-gray-50 rounded-lg p-3 text-sm">
              <p class="font-semibold accent-deep mb-2">Responses from:</p>
              <div class="space-y-1">
                ${parts.map(p => {
                  const name = p.participant_name;
                  const ok = w.responded.includes(name);
                  return `<div class="${ok ? 'text-green-700' : 'text-gray-500'}">${ok ? '‚úì' : '‚Ä¢'} ${escapeHtml(name)}</div>`;
                }).join('')}
              </div>
            </div>

            <button type="button"
                    class="w-full mt-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold py-2"
                    onclick="toggleWineDetails('${escapeHtml(String(w.wine_number))}')">
              üé≠ ${w._revealed ? 'Hide wine' : 'Reveal wine'}
            </button>

            <div id="wine-details-${escapeHtml(String(w.wine_number))}" class="hidden mt-3 border-l-4 border-purple-600 bg-white rounded-lg p-3 text-sm">
              <p class="font-bold accent-deep">${escapeHtml(w.wine_name || '')}</p>
              <div class="mt-2 space-y-1 text-gray-700">
                ${w.grape ? `<p><span class="font-semibold">Grape:</span> ${escapeHtml(String(w.grape))}</p>` : ''}
                ${w.country ? `<p><span class="font-semibold">Country:</span> ${escapeHtml(String(w.country))}</p>` : ''}
                ${w.price !== '' && w.price !== null && w.price !== undefined ? `<p><span class="font-semibold">Price:</span> ‚Ç¨${Number(w.price).toFixed(1)}</p>` : ''}
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';

      // Keep the existing analysis block (if you want it)
      const analysis = analyzeWineTastes();
      html += '<hr class="my-8">';
      html += '<div><h3 class="font-display text-xl font-bold accent-deep mb-4">üìä Wine analysis</h3>';
      html += '<div class="space-y-2">';
      if (analysis.sweetest) html += `<div class="bg-white p-3 rounded-lg"><span class="font-semibold accent-deep">üç¨ Sweetaste:</span> Wine ${escapeHtml(String(analysis.sweetest))}</div>`;
      if (analysis.driest) html += `<div class="bg-white p-3 rounded-lg"><span class="font-semibold accent-deep">üçÉ Dryaste:</span> Wine ${escapeHtml(String(analysis.driest))}</div>`;
      if (analysis.fullest) html += `<div class="bg-white p-3 rounded-lg"><span class="font-semibold accent-deep">üí™ Full-bodiedaste:</span> Wine ${escapeHtml(String(analysis.fullest))}</div>`;
      if (analysis.lightest) html += `<div class="bg-white p-3 rounded-lg"><span class="font-semibold accent-deep">‚òÅÔ∏è Lightaste:</span> Wine ${escapeHtml(String(analysis.lightest))}</div>`;
      if (analysis.mostAroma (how strong is the smell?)) html += `<div class="bg-white p-3 rounded-lg"><span class="font-semibold accent-deep">üëÉ Most aroma:</span> Wine ${escapeHtml(String(analysis.mostAroma (how strong is the smell?)))}</div>`;
      if (analysis.leastAroma (how strong is the smell?)) html += `<div class="bg-white p-3 rounded-lg"><span class="font-semibold accent-deep">üò∂ Least aroma:</span> Wine ${escapeHtml(String(analysis.leastAroma (how strong is the smell?)))}</div>`;
      if (analysis.mostAcidity (freshness)) html += `<div class="bg-white p-3 rounded-lg"><span class="font-semibold accent-deep">üçã Highst syra:</span> Wine ${escapeHtml(String(analysis.mostAcidity (freshness)))}</div>`;
      if (analysis.leastAcidity (freshness)) html += `<div class="bg-white p-3 rounded-lg"><span class="font-semibold accent-deep">ü•õ Lowest acidity:</span> Wine ${escapeHtml(String(analysis.leastAcidity (freshness)))}</div>`;
      html += '</div></div>';

      container.innerHTML = html;
    }

    function toggleWineDetails(wineNumber) {
      const el = document.getElementById(`wine-details-${wineNumber}`);
      if (!el) return;
      el.classList.toggle('hidden');
    }

    function toggleWineParticipants(wineNumber) {
      const el = document.getElementById(`wine-participants-${wineNumber}`);
      if (!el) return;
      el.classList.toggle('hidden');
    }


    function renderWineReveal() {
      const container = document.getElementById("wine-reveal");
      const wineList = wines.slice().sort((a,b)=> (a.wine_number||0) - (b.wine_number||0));
      container.innerHTML = wineList.map(w => `
        <div class="bg-white p-4 rounded-lg border-l-4 border-purple-600">
          <p class="font-bold accent-deep text-lg">Wine ${w.wine_number}: ${escapeHtml(w.wine_name)}</p>
          <div class="mt-2 space-y-1 text-sm text-gray-700">
            <p><span class="font-semibold">Grape:</span> ${escapeHtml(w.grape)}</p>
            <p><span class="font-semibold">Country:</span> ${escapeHtml(w.country)}</p>
            <p><span class="font-semibold">Price:</span> ‚Ç¨${Number(w.price).toFixed(1)}</p>
          </div>
        </div>
      `).join("");
    }

    window.toggleWineReveal = function(evt) {
      const reveal = document.getElementById("wine-reveal");
      const btn = evt.target;
      if (reveal.classList.contains("hidden")) {
        reveal.classList.remove("hidden");
        btn.textContent = "üé≠ D√∂lj Vinen";
        renderWineReveal();
      } else {
        reveal.classList.add("hidden");
        btn.textContent = "üé≠ Reveal wines";
      }
    };

    function renderQuizResultsPage() {
      const container = document.getElementById("quiz-results-content");
      const QUESTIONS = getQuestionsForRun();

      const quizList = quizResults.slice().sort((a,b)=> (b.quiz_score||0) - (a.quiz_score||0));
      if (!quizList.length) { container.innerHTML = '<p class="text-gray-600">No quiz results yet</p>'; return; }

      const best = new Map();
      quizList.forEach(q => {
        const prev = best.get(q.participant_name);
        if (!prev || (q.quiz_score||0) > (prev.quiz_score||0)) best.set(q.participant_name, q);
      });
      const ranked = Array.from(best.values()).sort((a,b)=> (b.quiz_score||0) - (a.quiz_score||0));

      let html = '<div class="mb-6">';
      html += renderRankedList(ranked, r => r.participant_name, r => `${r.quiz_score}/${QUESTIONS.length}`);
      html += "</div>";

      html += '<div class="space-y-2">';
      ranked.forEach((result) => {
        const answers = JSON.parse(result.quiz_answers || "{}");
        html += `
          <div class="bg-white p-3 rounded-lg cursor-pointer" onclick="toggleDetails(this)">
            <div class="flex justify-between items-center">
              <span class="font-semibold accent-deep">${escapeHtml(result.participant_name)}</span>
              <span class="font-bold">${result.quiz_score}/${QUESTIONS.length}</span>
            </div>
            <div class="hidden mt-3 px-3 py-2 bg-gray-100 rounded-lg max-h-96 overflow-y-auto space-y-2">
              ${QUESTIONS.map(q => {
                const userAnswer = answers[q.id];
                const correct = userAnswer === q.correct;
                const correctAnswer = q.opts.find(opt => opt[0] === q.correct);
                const userAnswerText = userAnswer ? (q.opts.find(opt => opt[0] === userAnswer)?.[1] || "") : "No answer";
                return `
                  <div class="bg-white p-2 rounded border-l-2 text-xs ${correct ? "border-green-500" : "border-red-500"}">
                    <p class="font-semibold accent-deep text-gray-800 mb-1">${escapeHtml(q.q)}</p>
                    <p class="text-gray-700"><span class="font-semibold">Your answer:</span> ${escapeHtml(userAnswerText)} ${correct ? "‚úì" : "‚úó"}</p>
                    ${!correct ? `<p class="text-gray-700"><span class="font-semibold">Correct answer:</span> ${escapeHtml(correctAnswer?.[1] || "")}</p>` : ""}
                  </div>
                `;
              }).join("")}
            </div>
          </div>
        `;
      });
      html += "</div>";

      container.innerHTML = html;
    }

    window.toggleDetails = function(element) {
      const details = element.querySelector(".hidden");
      if (details) details.classList.toggle("hidden");
    };

    function normalizeEditorQuestions() {
      return quizQuestions.map((q, idx) => {
        const id = q.id ?? (idx+1);
        const opts = Array.isArray(q.opts) ? q.opts : [["1",""],["X",""],["2",""]];
        const safeOpts = [["1",""],["X",""],["2",""]].map(([k,_],i)=> {
          const found = opts.find(o=>o[0]===k) || opts[i] || [k,""];
          return [k, String(found[1] ?? "")];
        });
        const correct = ["1","X","2"].includes(q.correct) ? q.correct : "1";
        return { id, q: String(q.q ?? ""), opts: safeOpts, correct };
      });
    }

    function renderQuizEditor() {
      const root = document.getElementById("quiz-editor");
      const qs = normalizeEditorQuestions();
      root.innerHTML = qs.map((q, idx) => `
        <div class="bg-white rounded-lg p-4 border border-gray-200">
          <div class="flex items-center justify-between mb-3">
            <div class="font-semibold text-gray-800">Question #${idx+1}</div>
            <button class="text-red-600 font-semibold" onclick="removeQuestion(${idx})">Remove</button>
          </div>
          <textarea class="w-full border border-gray-300 rounded-lg mb-3" rows="2" placeholder="Write the question..." oninput="updateQuestionText(${idx}, this.value)">${escapeHtml(q.q)}</textarea>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
            <input class="border border-gray-300 rounded-lg" placeholder="1: option" value="${escapeHtml(q.opts[0][1])}" oninput="updateQuestionOpt(${idx}, '1', this.value)" />
            <input class="border border-gray-300 rounded-lg" placeholder="X: option" value="${escapeHtml(q.opts[1][1])}" oninput="updateQuestionOpt(${idx}, 'X', this.value)" />
            <input class="border border-gray-300 rounded-lg" placeholder="2: option" value="${escapeHtml(q.opts[2][1])}" oninput="updateQuestionOpt(${idx}, '2', this.value)" />
          </div>
          <div class="mt-3 flex items-center gap-3 text-sm">
            <span class="font-semibold text-gray-700">Correct answer:</span>
            <label class="flex items-center gap-1"><input type="radio" name="correct-${idx}" ${q.correct==='1'?'checked':''} onchange="updateQuestionCorrect(${idx}, '1')" /> 1</label>
            <label class="flex items-center gap-1"><input type="radio" name="correct-${idx}" ${q.correct==='X'?'checked':''} onchange="updateQuestionCorrect(${idx}, 'X')" /> X</label>
            <label class="flex items-center gap-1"><input type="radio" name="correct-${idx}" ${q.correct==='2'?'checked':''} onchange="updateQuestionCorrect(${idx}, '2')" /> 2</label>
          </div>
        </div>
      `).join("");
    }

    window.addEmptyQuestion = function() {
      const nextId = (quizQuestions.reduce((m,q)=>Math.max(m, Number(q.id||0)), 0) || 0) + 1;
      quizQuestions.push({ id: nextId, q: "", opts: [["1",""],["X",""],["2",""]], correct: "1" });
      renderQuizEditor();
    };

    window.removeQuestion = function(idx) {
      quizQuestions.splice(idx, 1);
      renderQuizEditor();
    };

    window.updateQuestionText = function(idx, value) { quizQuestions[idx].q = value; };
    window.updateQuestionOpt = function(idx, key, value) {
      const q = quizQuestions[idx];
      const i = q.opts.findIndex(o => o[0] === key);
      if (i >= 0) q.opts[i][1] = value;
    };
    window.updateQuestionCorrect = function(idx, key) { quizQuestions[idx].correct = key; };

    window.loadDefaultQuestions = function() {
      quizQuestions = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
      renderQuizEditor();
      showToast("Standardfr√•gor laddade (kom ih√•g att trycka Save quiz)");
    };
    window.toggleQuizEditor = function() {
      const panel = document.getElementById('quiz-editor-panel');
      if (!panel) return;
      panel.classList.toggle('hidden');
      // Scrolla s√• man ser editorn n√§r man √∂ppnar
      if (!panel.classList.contains('hidden')) {
        setTimeout(() => panel.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
      }
    }

window.saveQuizQuestions = async function() {
      try {
        await ensureSignedIn();
        await ensureSignedIn();
        const cleaned = normalizeEditorQuestions().filter(q => q.q.trim().length > 0).map((q, i) => ({ ...q, id: i+1 }));
        await setDoc(metaDoc, { quiz_questions: cleaned }, { merge: true });
        showToast("Quiz sparat!");
        const panel = document.getElementById("quiz-editor-panel");
        if (panel) panel.classList.add("hidden");
      } catch (e) {
        console.error(e);
        showToast("Couldn't save quiz (permissions/rules).", "error");
      }
    };

    window.resetTastings = function() {
      if (!confirm("Are you sure? This will delete all tastings.")) return;
      (async () => {
        try { for (const t of tastings) await deleteItemById(t.id); showToast("Tastings reset!"); }
        catch (e) { console.error(e); showToast("Kunde inte √•terst√§lla (kolla Rules)", "error"); }
      })();
    };

    window.resetQuiz = function() {
      if (!confirm("Are you sure? This will delete all quiz results.")) return;
      (async () => {
        try { for (const q of quizResults) await deleteItemById(q.id); showToast("Quiz results reset!"); }
        catch (e) { console.error(e); showToast("Kunde inte √•terst√§lla (kolla Rules)", "error"); }
      })();
    };

    function wireListeners() {
      const qItems = query(itemsCol, orderBy("createdAt", "asc"));
      onSnapshot(qItems, (snap) => {
        const docs = snap.docs.map(d => ({ __id: d.id, ...d.data() }));
        allItems = docs;

        participants = docs.filter(x => x.type === 'participant');
        wines = docs.filter(x => x.type === 'wine').sort((a, b) => (a.wine_number || 0) - (b.wine_number || 0));
        tastings = docs.filter(x => x.type === 'tasting');
        quizResults = docs.filter(x => x.type === 'quiz');
        
        // H√•ll UI i synk med realtidsdata oavsett vilken flik du √§r p√•
        if (!document.getElementById('settings-section').classList.contains('hidden')) {
          renderParticipants();
          renderWinesList();
        }
        if (!document.getElementById('tasting-section').classList.contains('hidden')) {
          renderTastingSelects();
        }
        if (!document.getElementById('quiz-section').classList.contains('hidden')) {
          renderQuizParticipants();
        }
        if (!document.getElementById('tasting-results-section').classList.contains('hidden')) {
          renderTastingResultsPage();
        }
        if (!document.getElementById('quiz-results-section').classList.contains('hidden')) {
          renderQuizResultsPage();
        }
        const qe = document.getElementById('quiz-editor');
        if (qe && !qe.classList.contains('hidden')) {
          renderQuizEditor();
        }
      });onSnapshot(metaDoc, (snap) => {
        const cfg = snap.exists() ? snap.data() : {};
        const title = cfg.event_title || defaultConfig.event_title;
        document.getElementById("event-title").textContent = title;
        if (document.activeElement !== document.getElementById("event-name-input")) {
          document.getElementById("event-name-input").value = title;
        }
        quizQuestions = Array.isArray(cfg.quiz_questions) && cfg.quiz_questions.length ? cfg.quiz_questions : JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
        if (!document.getElementById("settings-section").classList.contains("hidden")) renderQuizEditor();
      }, (err) => { console.error(err); showToast('Check rules (missing permission to read event config).', 'error'); });
    }

    async function boot() {
  // 1) Ensure we have an authenticated user (anonymous is fine)
  const pill = document.getElementById("connection-status");
  try {
    if (auth.currentUser) {
      if (pill) pill.textContent = "‚úÖ Connected";
    } else {
      await signInAnonymously(auth);
      if (pill) pill.textContent = "‚úÖ Connected";
    }
  } catch (e) {
    console.error("Anonymous sign-in failed", e);
    if (pill) pill.textContent = "‚ùå Not connected";
    showFatal(`‚ö†Ô∏è Auth failed: ${e?.code || ""} ${e?.message || e} ‚Äî Fix in Firebase: Authentication ‚Üí Sign-in method ‚Üí enable Anonymous. Authentication ‚Üí Settings ‚Üí Authorized domains ‚Üí add winetasting-ten.vercel.app.`);
    showToast(`Auth failed: ${e?.code || ""} ${e?.message || e}`, "error");
    return;
  }

  onAuthStateChanged(auth, (u) => {
    const p = document.getElementById("connection-status");
    if (!p) return;
    p.textContent = u ? "‚úÖ Connected" : "‚è≥ Connecting‚Ä¶";
  });

  // 2) Load event config (title, password flag, quiz questions)
      await loadEventConfig();

      // 3) Start realtime listeners AFTER auth is ready (avoids permission-denied race)
      wireListeners();

      
// Normalize country fields on blur (helps beginners)
const wineCountryEl = document.getElementById("wine-country");
if (wineCountryEl) {
  wineCountryEl.addEventListener("blur", () => {
    const norm = normalizeCountryInput(wineCountryEl.value);
    if (norm) wineCountryEl.value = norm;
  });
}
const guessCountryEl = document.getElementById("tasting-guess-country");
if (guessCountryEl) {
  guessCountryEl.addEventListener("blur", () => {
    const norm = normalizeCountryInput(guessCountryEl.value);
    if (norm) guessCountryEl.value = norm;
  });
}

      // 4) Default view
      window.showSettings();
    }

    // Expose functions used by inline onclick handlers (module scope -> window)
    window.toggleWineParticipants = toggleWineParticipants;
    window.toggleWineDetails = toggleWineDetails;


    onAuthStateChanged(auth, () => {});
    boot();
  </script>
</body>
</html>
